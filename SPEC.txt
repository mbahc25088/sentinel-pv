VERSION DOOM — AUTHORITATIVE SPEC
=================================

Project: sentinel-pv
Version: VERSION DOOM
Status: Phase 1 COMPLETE AND LOCKED
Last Verified State: Docker + FastAPI + PostgreSQL running successfully

------------------------------------------------------------
GLOBAL RULES (HARD LOCK)
------------------------------------------------------------

1. SPEC.txt is the single source of truth.
2. Code is judged against SPEC.txt, never against memory.
3. Any file change requires FULL FILE REPLACEMENT.
4. No renames, no path changes unless explicitly unlocked.
5. Docker is the only supported execution environment.
6. PostgreSQL is the sole system of record.
7. Human-in-the-loop is mandatory; no autonomous regulatory decisions.
8. Frontend must consume backend contracts exactly when introduced.
9. Phase once locked may not be reinterpreted.

------------------------------------------------------------
PROJECT TREE (FROZEN FOR PHASE 1)
------------------------------------------------------------

sentinel-pv/
├── docker-compose.yml
├── SPEC.txt
└── backend/
    ├── Dockerfile
    ├── requirements.txt
    └── app/
        ├── __init__.py
        ├── main.py
        ├── lifecycle.py
        ├── config.py
        └── invariants.py

------------------------------------------------------------
DOCKER ORCHESTRATION
------------------------------------------------------------

docker-compose.yml

Responsibilities:
- Orchestrate backend and PostgreSQL
- Define environment variables
- Create persistent volume for Postgres
- Enforce startup ordering

Services:
- sentinel-pv-backend (FastAPI + Uvicorn)
- sentinel-pv-postgres (PostgreSQL 15)

Guarantees:
- Backend will not start without Postgres availability
- Database data persists across container restarts
- All services run on an isolated Docker network

------------------------------------------------------------
BACKEND CONTAINER
------------------------------------------------------------

backend/Dockerfile

Responsibilities:
- Define Python 3.11 runtime
- Install dependencies from requirements.txt
- Set PYTHONPATH=/app
- Launch FastAPI via Uvicorn

Critical Invariants:
- Build context is repository root
- backend/app is copied into /app
- No dynamic path manipulation allowed

------------------------------------------------------------
APPLICATION LAYER
------------------------------------------------------------

app/main.py

Role:
- Single FastAPI entrypoint
- Registers startup and shutdown hooks
- Exposes root inspection endpoint

Startup Flow:
1. FastAPI instance is created
2. startup_event() is awaited
3. Runtime invariants are asserted
4. Application becomes available

Shutdown Flow:
- shutdown_event() is awaited for clean teardown

Public Endpoint:
GET /
Returns:
- service name
- environment
- lifecycle state

------------------------------------------------------------

app/lifecycle.py

Role:
- Owns the system lifecycle state machine

Responsibilities:
- Track lifecycle state
- Enforce valid transitions
- Coordinate startup and shutdown
- Invoke invariant enforcement

Lifecycle States (implicit, internal):
- INIT
- RUNNING
- SHUTTING_DOWN

Lifecycle is authoritative and may not be bypassed.

------------------------------------------------------------

app/config.py

Role:
- Central configuration spine

Responsibilities:
- Load environment variables
- Provide typed configuration access
- Isolate configuration from business logic

Constraints:
- Compatible with Pydantic v2
- No hardcoded secrets
- No runtime mutation of config

------------------------------------------------------------

app/invariants.py

Role:
- Runtime safety enforcement

Responsibilities:
- Validate required environment variables
- Enforce one-of requirements
- Abort startup on misconfiguration

Failure Mode:
- Raises InvariantViolation
- Application startup is aborted intentionally

------------------------------------------------------------
DATA LAYER (INFRASTRUCTURE ONLY — PHASE 1)
------------------------------------------------------------

PostgreSQL:
- Version: 15.x
- Managed via Docker
- Persistent volume: sentinel-pv_pgdata
- Authentication: trust (development only)

Notes:
- No schemas defined yet
- No migrations yet
- This is intentional and locked for Phase 1

------------------------------------------------------------
PHASE STATUS
------------------------------------------------------------

Phase 1 — Runtime & Lifecycle Foundation

Subsections:
- 1.1 Runtime spine
- 1.2 Dockerization
- 1.3 Lifecycle engine
- 1.4 Configuration spine
- 1.5 Invariants and safety gates
- 1.6 PostgreSQL wiring

Status:
- Phase 1 COMPLETE
- Phase 1 LOCKED

------------------------------------------------------------
END OF SPEC
------------------------------------------------------------
